

# AndroidAPS Autotune adaptation

## Autotune Plugin files

### AutotunePlugin

<=> oref0-autotune.sh

<=> default value for Autotune log is **disable** (autotune always generate a dedicated log file in autotune subfolder)

### AutotuneFragment

User Interface

### AutotunePrep

<=> oref0-autotune-prep.js + lib/autotune-prep

### AutotuneCore

<=> oref0-autotune-core.js = lib/autotune

### AutotuneIob

<=> lib/iob + lib/meal 

get ns-entries and ns-treatments input data for each days

exports these data as json file to run oref0-autotune algorythm with aaps data in a Virtual Machine

Make dedicated Iob calculation for autotune (specificities compared to iob calculation for loop...)

### AutotuneFS

Manage exported files for tests and  verifications of autotune plugin

=> Add settings and autotune subfolder in androidAps log folder

=> Add a zip file beside log files for each autotune run with all generated data

### data folder

PreppedGlucose: output data of AutotunePrep and input data of AutotuneCore (it contains BGDatum, CRDatum data)

ATProfile: (in core module) is used for profile management during autotune calculation and results

### oref0 folder

**oref0-autotune**.sh: main file used in Virtual Machine for autotune run (see oref0 in github)

**aaps-autotune**.sh: patched oref0-autotune.sh file to run oref0-autotune with aaps exported file (pumpprofile, ns-entries.yyyy-mm-dd.json and ns-treatments.yyyy-mm-dd.json). zip previous files and query are disabled (to check consistency between **autotune.yyyy-mm-dd.json** and **aaps-autotune.yyyy-mm-dd.json**)

**aaps1-autotune.sh**: patched oref0-autotune.sh file to run oref0-autotune-core with aaps-autotune.yyyy-mm-dd.json files

## Files generated by AAPS autotune plugin (for results verifications)

### How to compare results:

- To compare results, you have to install oref0 on a virtual linux machine, 

- add **aaps-autotune** and **aaps-autotune-recommends-report** files in `/usr/local/bin` folder

- create an `aaps` folder in user directory

- copy / paste the 2 folders generated by aaps autotune plugin in log folder (`autotune` and `settings`) with all files included

- then launch `oref0-autotune` command line or `aaps-autotune` command line from home

  **Note**, in the `settings.json` file exported in `settings` folder, you have the syntax of oref0_command (with NS queries), aaps_command (`aaps-autotune ....`) and the timezone command to apply same time zone than in AAPS application.

### Input files (for oref0 check)

- settings.json: contains all necessary information to be able to run oref0-autotune on a virtual machine (NS website, date of run, nb of days, timezone...)
- pumpprofile.json: current profile, (input data), converted in oref json format to be able to run oref0-autotune.sh (in settings folder and autotune folder)
- aaps-entries.yyyy-mm-dd.json (<=> ns-entries.yyyy-mm-dd.json): BG data get with line below and converted in NS json format 
- aaps-treatments.yyyy-mm-dd.json (<=> ns-entries.yyyy-mm-dd.json): all treatments for autotune calculation (meals, insulin, temp basals, extended basals). 

note oref0 autotune doesn't manage profile-switch so it could have some gap on iob calculation when no TBR running (calculation done with 4 hours average pumpprofile)

- It's important to be able to export in NS Json format all data used in aaps autotune plugin to be able to run oref0-autotune with the datas generated by aaps and compare results

**=> for testing results, I just have to copy input profile in settings folder (pumpprofile.json) and all aaps-entries and aaps-treatments files in autotune folder and run an ``aaps-autotune`` command (oref0-autotune.sh file with NS queries disabled), that way I can compared results and all detailled informations (aaps logs and oref0 logs are very close) and they must be exactly the same or as close as possible...**

**=> for only AutotuneCore module validation, we also copy in autotune folder of virtual machine all aaps-autotune.yyyy-mm-dd.json and newaapsprofile.yyyy-mm-dd.json files and use ``aaps1-autotune`` command**

### Ouput files

- autotune.json: output profile in aaps json format (in settings folder)
- aaps-autotune.yyyy-mm-dd.json (<=> autotune.yyyy-mm-dd.json): prepped data for autotuneCore calculation (same format than oref0 one so I can use them in virtual machine to compare oref0-autotune-core results)

- newaapsprofile.yyyy-mm-dd.json (<=> newprofile.yyyy-mm-dd.json): intermediate profiles foreach day

## Files generated by OAPS: (for results verifications)

### inputs data

- ``profil.json`` and ``pumpprofile.json``:
  - insulin informations (if not default "rapid-acting" insulin) is specified in ``pumpprofile.json`` file with an additional entry ``"curve":"ultra-rapid"``.
  - Free peak insulin are entered in pumpprofile.json file with this additional entries:  ``"insulinpeaktime":55 ``.
- ``ns-entries.yyyy-mm--dd.json``: BG data received from NSClient for each day (between 4 AM local hour and 4 AM following day). All BG are in reverse order (from end to start)

- ``ns-treatments.yyy-mm-dd.json``: Treatments data received from NSClient (6 hours before first BG data to last BG data). As query is done in UTC time on field "created_at", 12 hours extra data before and after are also downloaded...

### Output data

- ``autotune.yyy-mm-dd.json``: output file of  ``oref0-autotune-prep.js`` (and input of  ``oref0-autotune-core.js``). BG are grouped according to type (CSFGlucoseData, ISFGlucoseData or basalGlucoseData) with additional informations (mealCarbs, BGI, deviation)

## Differences between Oref0 Autotune and AAPS Autotune Plugin

### Why not exactly the same results between Oref0-Autotune and Autotune Plugin (with exactly the same input data)

- Oref0 IOB calculation for the TBRs splits each TBR every half an hour, then the absolute amount of Insulin for each "bloc" is divided in a number of little Bolus of 0.05U or -0.05U
  - In AAPS Plugin TBR are split each hour, then we can have some shifts for each timestamp of the little boluses of +/-0.05U that impact IOB calculation (the IOB is "approximatively" the same, but when we sum a lot of little gaps, we can see the impact on Basal values on second or third digit)
  - the number of very little boluses can vary according to rounding done
- Library used in kotlin and in linux system for Exponentiel curves are not the same
  - With exactly the same values of units, date of bolus, time of iob calculation, insulin iob and activity calculated on kotlin and linux with exponential curves are not "exactly" the same (results are very close)

### Why not exactly the same results between Autotune-Web and Autotune Plugin

- Autotune Web doesn't take into account periods with no TBR running (these period doesn't have entries or "neutral TBR"), the impact of all these periods are not included in iob calculation and activities.
  - These "empty" periods are filled with neutral TBR (TBR with absolute value consistant with basal rate) to be included in calculation done by AAPS plugin and exported files for oref0 verification on virtual machine
- For pumps that works with percent TBR
  - Absolute amount of TBR exported from AAPS are calculated with the "timestamp" of the TBR (no split for each hour change), but basal rates can be different on hour changes:
    - If a TBR starts at 10:59 and finish at 11:59, the absolute amount will be calculated with basal rate of Timestamp (10h), even if 59 min of TBR was injected with basal rate of the hour after (11h)
  - In AAPS plugin each TBR and extended TBR is splitted every hour to include changes in basal rates, and this splits are included in exported files for oref0 verifications
- You cannot select custom peak or Lyumjev insulin in Autotune-Web (only Rapid-Acting and Fiasp can be selected)
  - if you use lyumjev, using FIASP settings for autotune have major impact on results because of Peak duration

## Funtionalities and limitations of current version of AAPS Autotune plugin (compare to oref0)

- Categorize UAM as basal setting available (in preferences)
- Number of days can be selected (default value in preferences, you can customized in UI)
- Launch Autotune with an automation rule is possible
- Automatically "Switch profile" can be activated in preferences (default = false)
- From main UI you can :
  - Adjust number of days for calculation, Run Autotune, see partial results
  - Compare profiles, 
  - Copy tuned profile in Local Profile plugin (to allow modification before activation), 
  - Activate Tuned profile manualy after calculation
- Tune of Insulin (peak and dia) is not available
- Tune of specific days of the week is not available
- You cannot select a specific profile to tune (calculation done with current active profile in aaps)
  - be carefull, you shouldn't have a Temporary Profile Switch with "percent"

## Further improvements

- Include Insulin tuning (for Peak and DIA) will be easier if we manage Insulin in Profile (not only DIA)
- Apply ISF and IC percentage (autotune calculated on average values if circadian profile for ISF and IC) on circadian ISF and IC (it's not an circadian autotune, but we can keep circadian adjustment made by the user and apply average modifications proposed by Autotune)
- Improve Results presentation (html format)
- Allow selection of profile to tune (in user interface and in automation rule)
- Allow an "Automatic update" of Source profile
- Allow week days selection (to be able to tune working days, WE days, training days with dedicated profiles) in user interface and in automation rule